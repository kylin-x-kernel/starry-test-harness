name: daily-test

on:
  # Nightly run. Note: schedules are evaluated from the default branch.
  schedule:
    - cron: '0 16 * * *'
  # Allow manual trigger with an optional ref override.
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to test (branch/tag/SHA). Leave empty to use master.'
        required: false
        type: string
      output_branch:
        description: 'è¾“å‡ºç»“æžœçš„åˆ†æ”¯åç§°ï¼ˆé»˜è®¤ï¼šdaily-test-resultsï¼‰'
        required: false
        default: 'daily-test-results'

concurrency:
  # Avoid overlapping runs on the same ref/event.
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}

jobs:
  daily:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™æƒé™ä»¥æŽ¨é€åˆ°ç»“æžœåˆ†æ”¯
    env:
      # Default test target for scheduled runs.
      TEST_REF: ${{ github.event.inputs.ref || 'master' }}
      ARCH: aarch64
      STARRYOS_REMOTE: https://github.com/kylin-x-kernel/StarryOS.git
      STARRYOS_REF: main
      STARRYOS_ROOT: ${{ github.workspace }}/.cache/StarryOS
    steps:
      # Check out the repo at the target ref (master by default).
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.TEST_REF }}

      # Cache Rust artifacts across runs to speed up CI.
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: starry-daily-harness

      # Toolchain setup for musl-based build target.
      - name: Install musl toolchain
        uses: arceos-org/setup-musl@v1
        with:
          arch: ${{ env.ARCH }}

      # QEMU is required to run the tests under emulation.
      - name: Install QEMU
        uses: arceos-org/setup-qemu@v1
        with:
          version: 10.1.0
          arch_list: ${{ env.ARCH }}

      # Filesystem tools used by the test harness.
      - name: Install filesystem tools
        run: sudo apt-get update && sudo apt-get install -y e2fsprogs xz-utils

      - name: Ensure StarryOS build artifacts
        run: |
          if ! ls -1 "${STARRYOS_ROOT}"/StarryOS_"${ARCH}"*-qemu-virt.bin >/dev/null 2>&1; then
            echo "StarryOS kernel not found, building..."
            scripts/build_starry.sh daily-test
          fi

      # Run the daily test target.
      - name: æ‰§è¡Œ daily-test
        run: make daily-test run

      # Pick the most recent run directory for artifact naming.
      - name: Prepare artifact name and timestamp
        if: always()
        id: prepare
        run: |
          if [ -d logs/daily ]; then
            RUN_DIR="$(ls -1 logs/daily | grep -E '^[0-9]{8}-[0-9]{6}$' | sort | tail -n1)"
          else
            RUN_DIR=""
          fi
          echo "RUN_DIR=${RUN_DIR:-unknown}" >> "$GITHUB_ENV"
          echo "run_dir=${RUN_DIR:-unknown}" >> "$GITHUB_OUTPUT"
          echo "timestamp=$(date +'%Y%m%d-%H%M%S')" >> "$GITHUB_OUTPUT"

      # Generate detailed test report in Markdown format
      - name: Generate test report
        if: always()
        run: |
          mkdir -p test-report
          python3 - <<'PY'
          import json
          import os
          from pathlib import Path
          from datetime import datetime

          # è¯»å–æµ‹è¯•ç»“æžœ
          path = Path("logs/daily/last_run.json")
          if not path.exists():
            print("âš ï¸  No last_run.json found.")
            Path("test-report/report.md").write_text("# æµ‹è¯•æŠ¥å‘Š\n\nâš ï¸ æœªæ‰¾åˆ°æµ‹è¯•ç»“æžœæ–‡ä»¶\n")
            raise SystemExit(0)

          data = json.loads(path.read_text())
          cases = data.get("cases", [])
          started_at = data.get("started_at", "")
          finished_at = data.get("finished_at", "")
          duration_ms = data.get("duration_ms", 0)
          
          def normalize_status(raw):
            return {
              "passed": "pass",
              "failed": "fail",
              "skipped": "skip",
            }.get(raw, raw)

          # ç»Ÿè®¡ä¿¡æ¯
          total = len(cases)
          passed = sum(1 for c in cases if normalize_status(c.get("status", "")) == "pass")
          failed = sum(1 for c in cases if normalize_status(c.get("status", "")) == "fail")
          skipped = sum(1 for c in cases if normalize_status(c.get("status", "")) == "skip")
          
          # ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
          lines = [
            "# StarryOS Daily Test Report",
            "",
            f"**è¿è¡Œæ—¶é—´**: {started_at} â†’ {finished_at}",
            f"**æ€»è€—æ—¶**: {duration_ms/1000:.2f}s",
            "",
            "## ðŸ“Š æµ‹è¯•æ¦‚è§ˆ",
            "",
            f"- âœ… **é€šè¿‡**: {passed}/{total}",
            f"- âŒ **å¤±è´¥**: {failed}/{total}",
            f"- â­ï¸  **è·³è¿‡**: {skipped}/{total}",
            f"- ðŸ“ˆ **é€šè¿‡çŽ‡**: {(passed/total*100 if total > 0 else 0):.1f}%",
            "",
            "## ðŸ“‹ æµ‹è¯•ç”¨ä¾‹è¯¦æƒ…",
            "",
          ]
          
          for case in cases:
            name = case.get("name", "")
            status_raw = case.get("status", "")
            status = normalize_status(status_raw)
            duration_ms = case.get("duration_ms") or 0
            duration_s = f"{duration_ms/1000:.2f}"
            metrics = case.get("test_metrics") or {}
            score = metrics.get("score")
            err = case.get("error_summary") or ""
            
            # çŠ¶æ€å›¾æ ‡
            status_icon = {
              "pass": "âœ…",
              "fail": "âŒ",
              "skip": "â­ï¸",
            }.get(status, "â“")
            
            lines.append(f"### {status_icon} {name}")
            lines.append("")
            lines.append(f"- **çŠ¶æ€**: `{status}`")
            lines.append(f"- **è€—æ—¶**: {duration_s}s")
            
            if score is not None:
              score_type = metrics.get("score_type", "")
              lines.append(f"- **å¾—åˆ†**: {score:.2f} ({score_type})")
            
            # æ˜¾ç¤ºè¯¦ç»†æŒ‡æ ‡
            if "metrics" in metrics and metrics["metrics"]:
              lines.append("- **è¯¦ç»†æŒ‡æ ‡**:")
              lines.append("")
              lines.append("  | æŒ‡æ ‡åç§° | Parallel | Baseline | Result | Index |")
              lines.append("  | --- | --- | --- | --- | --- |")
              for m in metrics["metrics"]:
                m_name = m.get("name", "")
                m_parallel = m.get("parallel")
                m_baseline = m.get("baseline", "")
                m_result = m.get("result", "")
                m_index = m.get("index", "")
                parallel_str = str(m_parallel) if m_parallel is not None else "---"
                baseline_str = f"{m_baseline:.2f}" if m_baseline not in ["", None] else "---"
                result_str = f"{m_result:.2f}" if m_result not in ["", None] else "---"
                index_str = f"{m_index:.2f}" if m_index not in ["", None] else "---"
                lines.append(f"  | {m_name} | {parallel_str} | {baseline_str} | {result_str} | {index_str} |")
              lines.append("")
            
            if err:
              lines.append(f"- **é”™è¯¯ä¿¡æ¯**: {err}")
            
            lines.append("")
          
          # ä¿å­˜æŠ¥å‘Š
          report_md = "\n".join(lines)
          Path("test-report/report.md").write_text(report_md)
          
          # ä¹Ÿä¿å­˜ JSON å‰¯æœ¬
          Path("test-report/report.json").write_text(path.read_text())
          
          print("âœ… æµ‹è¯•æŠ¥å‘Šç”ŸæˆæˆåŠŸ")
          PY

      # Build a short summary table for GitHub Actions job summary.
      - name: Generate GitHub Actions summary
        if: always()
        run: |
          if [ -f test-report/report.md ]; then
            cat test-report/report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ æœªç”Ÿæˆæµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          fi

      # Upload raw logs as artifact (backup)
      - name: Upload daily logs as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-logs-${{ steps.prepare.outputs.run_dir }}
          path: |
            logs/daily/${{ steps.prepare.outputs.run_dir }}
            logs/daily/last_run.json
            test-report/
          retention-days: 90
          if-no-files-found: warn

      # Commit and push to results branch (persistent history)
      - name: Push results to branch
        if: always()
        env:
          OUTPUT_BRANCH: ${{ github.event.inputs.output_branch || 'daily-test-results' }}
          TIMESTAMP: ${{ steps.prepare.outputs.timestamp }}
          RUN_DIR: ${{ steps.prepare.outputs.run_dir }}
        run: |
          # é…ç½® git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # å¤‡ä»½æµ‹è¯•ç»“æžœåˆ°ä¸´æ—¶ç›®å½•
          mkdir -p /tmp/test-backup
          if [ -d "logs/daily/${RUN_DIR}" ]; then
            cp -r "logs/daily/${RUN_DIR}" /tmp/test-backup/
          fi
          if [ -f "logs/daily/last_run.json" ]; then
            cp "logs/daily/last_run.json" /tmp/test-backup/
          fi
          if [ -d "test-report" ]; then
            cp -r test-report /tmp/test-backup/
          fi
          
          # åˆ›å»ºæˆ–åˆ‡æ¢åˆ°ç»“æžœåˆ†æ”¯
          git fetch origin ${OUTPUT_BRANCH}:${OUTPUT_BRANCH} || true
          
          # æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git show-ref --verify --quiet refs/remotes/origin/${OUTPUT_BRANCH}; then
            # åˆ†æ”¯å­˜åœ¨ï¼ŒåŸºäºŽè¿œç«¯åˆ†æ”¯åˆ‡æ¢
            git checkout -B ${OUTPUT_BRANCH} origin/${OUTPUT_BRANCH}
            
            # æ£€æŸ¥æ˜¯å¦æœ‰éž reports çš„æ–‡ä»¶/ç›®å½•ï¼ˆè¯´æ˜Žåˆ†æ”¯è¢«æ±¡æŸ“äº†ï¼‰
            shopt -s dotglob nullglob
            needs_cleanup=false
            for item in *; do
              if [ "$item" != ".git" ] && [ "$item" != "reports" ]; then
                needs_cleanup=true
                break
              fi
            done
            
            if [ "$needs_cleanup" = true ]; then
              echo "åˆ†æ”¯åŒ…å«éž report æ–‡ä»¶ï¼Œæ‰§è¡Œæ¸…ç†..."
              
              # å¤‡ä»½æ—§çš„ reports ç›®å½•ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
              if [ -d "reports" ]; then
                echo "å¤‡ä»½æ—§çš„æŠ¥å‘Š..."
                cp -r reports /tmp/old-reports-backup
              fi
              
              # æ¸…ç†å·¥ä½œåŒºï¼ˆä¿ç•™ .gitï¼‰
              for item in *; do
                if [ "$item" != ".git" ]; then
                  rm -rf "$item"
                fi
              done
              # æ¸…ç©º git ç´¢å¼•
              git rm -rf --cached . 2>/dev/null || true
              
              # æ¢å¤æ—§çš„ reports ç›®å½•
              if [ -d "/tmp/old-reports-backup" ]; then
                echo "æ¢å¤æ—§çš„æŠ¥å‘Š..."
                cp -r /tmp/old-reports-backup reports
              fi
            else
              echo "åˆ†æ”¯å¹²å‡€ï¼Œè·³è¿‡æ¸…ç†"
            fi
          else
            # åˆ†æ”¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºå­¤ç«‹åˆ†æ”¯
            git checkout --orphan ${OUTPUT_BRANCH}
            # æ¸…ç©ºæš‚å­˜åŒº
            git rm -rf . 2>/dev/null || true
          fi
          
          # ç¡®ä¿ reports ç›®å½•å­˜åœ¨
          mkdir -p reports/${TIMESTAMP}
          
          # ä»Žä¸´æ—¶ç›®å½•å¤åˆ¶æµ‹è¯•ç»“æžœ
          if [ -f "/tmp/test-backup/last_run.json" ]; then
            cp /tmp/test-backup/last_run.json reports/${TIMESTAMP}/
            cp /tmp/test-backup/last_run.json reports/latest.json
          fi
          
          if [ -f "/tmp/test-backup/test-report/report.md" ]; then
            cp /tmp/test-backup/test-report/report.md reports/${TIMESTAMP}/
            cp /tmp/test-backup/test-report/report.md reports/latest.md
          fi
          
          if [ -f "/tmp/test-backup/test-report/report.json" ]; then
            cp /tmp/test-backup/test-report/report.json reports/${TIMESTAMP}/
          fi
          
          # å¤åˆ¶å®Œæ•´æ—¥å¿—ç›®å½•ï¼ˆå¯é€‰ï¼Œå¦‚æžœå¤ªå¤§å¯ä»¥æ³¨é‡ŠæŽ‰ï¼‰
          if [ -d "/tmp/test-backup/${RUN_DIR}" ]; then
            cp -r "/tmp/test-backup/${RUN_DIR}" reports/${TIMESTAMP}/logs
          fi
          
          # åˆ›å»ºç´¢å¼•æ–‡ä»¶
          cat > reports/README.md << 'EOF'
          # StarryOS Daily Test åŽ†å²æŠ¥å‘Š
          
          ## ðŸ“Š æœ€æ–°æŠ¥å‘Š
          
          - [æœ€æ–°æµ‹è¯•æŠ¥å‘Š (Markdown)](./latest.md)
          - [æœ€æ–°æµ‹è¯•æ•°æ® (JSON)](./latest.json)
          
          ## ðŸ“š åŽ†å²æŠ¥å‘Š
          
          EOF
          
          # åˆ—å‡ºæ‰€æœ‰åŽ†å²æŠ¥å‘Šï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰
          for dir in $(ls -1r reports/ | grep -E '^[0-9]{8}-[0-9]{6}$'); do
            if [ -d "reports/$dir" ]; then
              # å°è¯•ä»Ž JSON æå–çŠ¶æ€ä¿¡æ¯
              if [ -f "reports/$dir/last_run.json" ]; then
                summary=$(python3 -c "
          import json
          from pathlib import Path
          try:
              data = json.loads(Path('reports/$dir/last_run.json').read_text())
              cases = data.get('cases', [])
              total = len(cases)
              def normalize_status(raw):
                  return {
                      'passed': 'pass',
                      'failed': 'fail',
                      'skipped': 'skip',
                  }.get(raw, raw)
              passed = sum(1 for c in cases if normalize_status(c.get('status', '')) == 'pass')
              print(f'{passed}/{total} passed')
          except:
              print('N/A')
          " 2>/dev/null || echo "N/A")
                echo "- [\`$dir\`](./$dir/report.md) - $summary" >> reports/README.md
              else
                echo "- [\`$dir\`](./$dir/report.md)" >> reports/README.md
              fi
            fi
          done
          
          # æ·»åŠ å…ƒä¿¡æ¯
          cat > reports/latest-info.json << EOF
          {
            "timestamp": "${TIMESTAMP}",
            "run_dir": "${RUN_DIR}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "test_ref": "${{ env.TEST_REF }}",
            "workflow_run": "${{ github.run_id }}"
          }
          EOF
          
          # æäº¤æ›´æ”¹
          git add reports/
          git commit -m "ðŸ“Š Daily test æŠ¥å‘Š - ${TIMESTAMP}" || echo "No changes to commit"
          
          # æŽ¨é€åˆ°è¿œç¨‹
          git push -f origin ${OUTPUT_BRANCH}
          
          echo "âœ… æµ‹è¯•ç»“æžœå·²æŽ¨é€åˆ°åˆ†æ”¯: ${OUTPUT_BRANCH}"
          echo "ðŸ“Š æŸ¥çœ‹æŠ¥å‘Š: https://github.com/${{ github.repository }}/tree/${OUTPUT_BRANCH}/reports"
